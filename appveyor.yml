install:
  - 'set PATH=C:\Miniconda-x64;C:\Miniconda-x64\Scripts;%PATH%'
  - "conda config --set always_yes yes --set changeps1 no"
  - "conda update -q conda"
  - "conda info -a"
  - "conda install conda-build=1.21"
  
build_script:
  - "CALL conda build toolchain -c statiskit -c conda-forge"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
  - "CALL conda build boost_build -c statiskit -c conda-forge"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
  - "CALL conda build libboost_python -c statiskit -c conda-forge"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
  - "CALL conda build python-scons -c statiskit"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
  - "CALL conda build python-parse -c statiskit"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"

on_success:
  - 'IF NOT "%APPVEYOR_REPO_BRANCH%"=="master" exit /b 0'
  - 'IF "%ANACONDA_USERNAME%"=="" exit /b 0'
  - 'IF "%ANACONDA_PASSWORD%"=="" exit /b 0'
  - "CALL conda install -n root anaconda-client"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
  - 'CALL anaconda login --username "%ANACONDA_USERNAME%" --password "%ANACONDA_PASSWORD%" --hostname "AppVeyor%APPVEYOR_BUILD_NUMBER%"'
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
  - "FOR /f %%i in ('conda build toolchain --output') DO (set CONDA_FILE=%%i)"
  - 'set errorlevel_backup=%errorlevel%'
  - 'set errorlevel=0'
  - 'CALL anaconda upload --user statiskit %CONDA_FILE% || echo "upload failed"'
  - 'set errorlevel=%errorlevel_backup%'
  - "FOR /f %%i in ('conda build boost_build --output') DO (set CONDA_FILE=%%i)"
  - 'set errorlevel=0'
  - 'CALL anaconda upload --user statiskit %CONDA_FILE% || echo "upload failed"'
  - 'set errorlevel=%errorlevel_backup%'
  - "FOR /f %%i in ('conda build libboost_python --output') DO (set CONDA_FILE=%%i)"
  - 'set errorlevel=0'
  - 'CALL anaconda upload --user statiskit %CONDA_FILE% || echo "upload failed"'
  - 'set errorlevel=%errorlevel_backup%'
  - "FOR /f %%i in ('conda build python-scons --output') DO (set CONDA_FILE=%%i)"
  - 'set errorlevel=0'
  - 'CALL anaconda upload --user statiskit %CONDA_FILE% || echo "upload failed"'
  - 'set errorlevel=%errorlevel_backup%'
  - "FOR /f %%i in ('conda build python-parse --output') DO (set CONDA_FILE=%%i)"
  - 'set errorlevel=0'
  - 'CALL anaconda upload --user statiskit %CONDA_FILE% || echo "upload failed"'
  - 'set errorlevel=%errorlevel_backup%'
  - "CALL anaconda logout"
  - "IF %errorlevel% neq 0 exit /b %errorlevel%"
